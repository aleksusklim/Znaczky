### Znaczek #6:

_Копипащу анонс и полную справку (потому что отдельного описания не, но и несмотря на то, что говорят, что по ней тоже всё равно непонятно, что именно делает эта программа) утилитки для упорядочивания кучи файлов субтитров в списки по персонажам с возможностью воспроизвести любую реплику с высокой вероятностью успеха._

---

<http://klimaleksus.narod.ru/Files/4/AssEasyQuote1V0.rar>   
С пользой провёл разве что быстрое пробное тестирование:   
<http://klimaleksus.narod.ru/Files/T/aeq_test.mp3> (ответ кроется в вопросе, насколько быстро мне удалось такое смонтировать)  
– сделано на скорость, аж путём глупого внешнего перехвата выходящего потока из плеера, запускаемого моей же программой.  
Не знаю, получилось ли сделать отрывок более-менее связным или логичным, но это был просто тест потенциальных возможностей.

Учитывая, что у меня не было ни всех сезонов, ни высококачественных источников, ни даже файлов оригинальных субтитров (подбирал по русским).  
На фон взял первую попавшуюся, мне в таких ситуациях, как правило, всегда везёт.

---

Данная программа предназначена для пересортировки текста в нескольких файлах субтитров, чтобы упорядочить их по персонажам.  
Работает это следующим образом:  
– Программа считывает группу .ass файлов.  
– Каждая фраза извлекается, сохраняя имя персонажа (наименование стиля) и время.  
– Создаются документы-списки на каждого персонажа, в которые выгружаются фразы.  
– Реплики снабжаются абстрактными порядковыми номерами.  
– Сохраняется общий индексный файл, глобально закрепляющий за номерами реплик времена начала и конца, а также название исходного .ass

Далее программу можно использовать для выборочного воспроизведения реплик из оригинальных видеофайлов.  
Для этого:  
– Программа запускается фоновым процессом в трее, и предварительно сканирует папку с видеофайлами, запоминая их имена.  
– Далее она ждёт горячей клавиши, и по нажатию Ctrl+Alt+Space программа получает содержимое буфера обмена, ожидая обнаружить там номер некоторой строки (он должен быть скопирован вручную)  
– Если найденный номер соответствует имеющейся в индексном документе, и программа знает местонахождение видео (или аудио) с тем же именем – запускается фоновое воспроизведение через «Media Player Classic», поддерживающий начальное смещение.  
– Программа вычисляет оставшееся время, и после подаёт сигнал плееру об остановке воспроизведения. Возможны задержки во времени из-за загруженности процессора или медлительности чтения большого файла с диска.

Инструкция по запуску:  
– Соберите все свои видеофайлы в какую-нибудь папку. Они могут располагаться в разных подпапках внутри неё, но желательно, чтобы там нигде не было множества других файлов, не относящихся к видео или субтитрам.  
– Соберите все субтитры вместе, также можно в подпапках. Если у вас субтитры уже лежат рядом с видео, и вы хотите использовать именно их, то можно оставить их там (папка просто будет той же); если же рядом с видеофайлами находятся какие-то другие субтитры, то соберите нужные отдельно.  
– Убедитесь, что имена целевых субтитров (без расширения) попарно соответствуют видеофайлам; все файлы должны иметь разные имена, поскольку сравнение происходит без учёта пути. Желательно, чтобы использовались только латинские буквы и цифры, потому что всё остальное заменяется символом подчёркивания при сравнениях. Однако, если имена файлов отличаются именно латиницей и цифрами, то проблем не возникнет даже когда в именах присутствуют русские названия.  
– Запустите «AssEasyQuote1V0.exe» двойным щелчком. Перейдите в корневую папку, где лежат целевые субтитры – позже поиск будет произведён в ней и подпапках. Диалог сделан как «сохранение файла», однако туда ничего сохранено не будет (просто так было удобнее папку выбирать, потому что есть куда путь вставлять), нужно лишь в правильной папке формально «сохранить» под любым именем, или дважды щёлкнуть по любому файлу в ней.  
– Теперь выберите ту папку, из которой нужно брать видео. Это может быть та же самая папка, потому что в дальнейшем программа сумеет различить .ass субтитры от всего остального.  
– Наконец, настоящий диалог сохранения! Выбранное имя файла будет итоговым .ini списком соответствия номеров реплик. Рядом с ним появятся .txt файлы, с именами персонажей и их текстами.  
– Далее программа в трее сообщит о прогрессе обработки, и закроется. Можете зайти в целевую папку и посмотреть на извлечённые строчки.

Для прослушивания реплик:  
– Перетащить в Проводнике ваш созданный индексный .ini файл на «AssEasyQuote1V0.exe». Он будет прочитан, а указанная в нём папка видеофайлов – просканирована. Если программа уже была запущена, то прошлая её копия будет насильно закрыта. А чтобы не тащить индекс куда-то далеко, можете заранее переместить его в папку с программой (ему не нужны извлечённые реплики в соседних текстовых файлах персонажей – это вам они нужны).  
– Программа сообщит в трее, что готова. Теперь откройте любой документ с персонажа в любом текстовом редакторе. Скопируйте интересующую вас строку, или хотя бы её порядковый номер (это шестнадцатеричное число, а захваченные пробельные символы игнорируются). Нажмите Ctrl+Alt+Пробел.  
– В трее будет указано имя файла и целевое время этой фразы. Должен запуститься свёрнутый плеер, в котором должно запуститься соответствующее видео с правильного места, и по окончанию реплики остановиться. Если окно с плеером уже открыто, то оно и перехватит команду на воспроизведение.  
– Продолжайте слушать фразы, сколько вам нужно. Для выхода из программы, нажмите правой кнопкой на иконку в трее, и щёлкните «Exit». Если плеер по какой-то причине перестал воспроизводить, нажмите Ctrl+Alt+Space дважды – процесс плеера будет сброшен, и повторный вызов должен пройти хорошо. Чтобы воспроизведение не закончилось сразу после конца реплики, можете щёлкнуть по иконке в трее левой кнопкой мыши, остановив работу программы. Для возобновления, снимите галочку с «Script Paused» в контекстном меню иконки; возможно, понадобится закрыть плеер.  
– Реплики во фразах персонажей отделяются одной пустой строкой, если не следуют непосредственно друг за другом в исходных субтитрах; и двумя пустыми строками, если вообще принадлежат разным файлам. При создании файлов, если документ с таким персонажем уже существует, то он будет заменён новым – поэтому лучше всегда создавайте новую папку при выборе места для сохранения индексного файла.

Альтернативный способ обработки файлов:  
– Для этого нужен «современный» браузер, откройте файл «AssEasyQuote1V0.htm». Этот способ может быть оказаться быстрее предыдущего при очень большом числе субтитров и персонажей.  
– Сложите все субтитры в одну папку, и заархивируйте её в .zip  
– Откройте архив интерфейсом на страничке, или перетащите его на элемент загрузки файлов.  
– Страница, после обработки, вернёт вам некоторый файл. Сохраните его как .zip архив.  
– Распакуйте полученный файл. Там окажется, в том числе, один .ini файл.  
– Откройте его текстовым редактором, и вставьте на первую пустую строку полный путь к той папке, которую вы бы выбрали как папку с видеофайлами.  
– Всё, можете перетащить его на программу и пользоваться как обычно.

---

_А вот ещё этапы разработки и финальная версия скрипта, мониторящего доступность видео на Ютюбе._

---

Ну пока так, грубовато:  
<http://klimaleksus.narod.ru/Files/4/ytalert.txt>

Инструкция:  
1\) Зайти браузером на <https://www.youtube.com/oembed> (там «Not Found»)  
2\) Открыть консоль браузера (Ctrl+Shift+K/J/C)  
3\) Вставить туда содержимое текстового файла по первой ссылке.

4\) В текстовое поле вставить ссылку на какое-нибудь видео.  
5\) Нажать Enter или ADD. Добавить ещё несколько видео.

6\) Таймер пока одноразовый, без повторной проверки. Кнопка «now» запускает проверку данного, кнопка «DEL» – удаляет строку.  
7\) Посмотреть результаты работы скрипта – зелёный на хороших видео, красный на плохих.  
8\) Было бы здорово проверить, что существующее, но удалённое позже видео, при нажатии «now» начинает выдавать красный.

Осталось придумать, какие уведомления выдавать (думаю, что смогу звуком), и выбрать интервал обновления…

<http://klimaleksus.narod.ru/Files/4/ytalert1V1.txt>

– сейчас объясню, как работает.

Итак, опять же, вставить в консоль браузера.

Если текущая страница не «youtube.com/oembed», то скрипт либо сам переадресует туда в текущей вкладке (если посчитает её содержимое не важным), либо создаст большую кнопку, по которой можно будет перейти туда в новой вкладке (а если зажать Ctrl при щелчке, то скрипт попытается всё же использовать эту вкладку вместо новой). В любом случае, на целевой странице скрипт нужно будет вставить в консоль ещё раз.

Дальше как обычно, вставлять ссылки в поле (хотя я предпочитаю не ссылки кидать, а только сами идентификаторы видео типа «q7s1B-kd_Uc»). Применять можно по Enter или ADD.

Далее в таблице появится серая строка, и через секунду запросит обновления; но прежде идёт дополнительный запрос на заголовок и картинку для видео (ведь на блокированных видео эта информация не выдаётся).

Обновляемая строка горит либо голубым (если новая, или ещё до этого была зелёной), либо жёлтым (если была красная).  
Запрос ждёт 20 секунд, и если ответ не пришёл – будут посылаться повторные запросы каждые 20 секунд. Таймер будет идти от нуля в отрицательную сторону.

Пришедший ответ обновляет таймер, устанавливая его на случайное значение от 10 до 35 секунд. Если с видео всё хорошо, то строка станет зелёной.

Если же обнаружен статус "fail", то строка будет красной, и случится уведомление.  
Таймер, тем не менее, пойдёт как обычно к нулю, и последующий запрос всё равно произойдёт (скрипт же не знает, почему была неудача, может там сервер просто ответил «повторите позже», тем не менее «причина»будет выведена под названием видео).  
Таким образом, если вставлена некорректная ссылка, то уведомления будут случаться постоянно, примерно каждые 20 секунд.

Чтобы остановить такмер на конкретном видео, есть кнопка «stop» под ним. Она сделает цвет строки белым (если он был зелёным или голубым), либо розовым (если красный или жёлтый). Теперь обновлений не будет, а также кнопки «now» (обновить сейчас) и «DEL» (удалить строку) перестанут работать, пока кнопка «enable» (второе состояние этого «stop») не будет снова нажата.

Уведомление – это во-первых, «Desktop Notifications», и браузер, по идее, должен спросить разрешение у пользователя, при добавлении первого видео в таблицу. Нужно разрешить показ уведомлений!  
Если браузером поддерживается, то на экране возле трея будет появляться окошечко без иконки, но с идентификатором видео, причиной неудачи, и названием (если поместиться).

Во-вторых, должен быть слышен пронзительный звук сирены ^^.  
У меня работало во всех браузерах (ну кроме IE, на который я даже не рассчитывал и не пробовал, потому что в нём этот скрипт работать гарантированно не будет).  
Но возможно, если звука нет, то нужно зайти в настройки браузера и либо «включить звуки на веб-страницах», либо отметить «запускать все плагины» (вместо «по запросу / только важные»).

И в-третьих, заголовок страницы (вкладки окна / иконки панели задач) будет в течение пяти секунд постоянно меняться на всякую всячину.

Вот так, вроде всё.  
Думаю, что если какое-то видео действительно вдруг оказалось заблокированным – нужно остановить его таймер и принять меры.  
После того как меры приняты – нажать «enable» и удалить строку.

О, а ещё, строка в таблице может почему-то стать синей. Это произойдёт, если в ответе сервера не найден «status» вообще, или не равен ни «ok», ни «fail». Это ничего не изменит, должно по идее считаться, что ответ не пришёл (перезапрос через 20 секунд), но если происходит регулярно – дайте ссылку на такое видео))

P.S  
Блин, по-моему, я слишом грубо парсил результаты. Вполне возможно, что видео с названием, включающим символы \, &, <, >, = – может всё поломать.  
Или нет.

Багфикс + апдейт готов, вот новая версия:  
<http://klimaleksus.narod.ru/Files/4/ytalert1V2.txt>

Баг заключался в том, что \_возможно\_, новое добавленное видео могло сломать проверку всех предыдущих (угораздило же меня написать «if(A[i ].handle=v)…» и не заметить).

Изменения:  
– теперь промежутки времени (интервал, его рандомная добавка и ожидание ответа сервера) задаются как числа в поля на самой странице. Применяются мгновенно при изменении; если невалидно (интервал меньше 1, добавка меньше 0 или ожидание меньше 2, либо если не число) – подсвечивается розовым.  
– первый раз картинка на видео прогружается не сразу, а спустя три секунды (чтобы дать возможность маленькой прогрузится, если будет; хотя ждать её нужно было не так…)  
– таблица формально не пересоздаётся при добавлении очередной строки.  
– при остановке таймера, его кнопки «now» и «DEL» становятся визуально недоступны.  
– идентификатор видео во втором столбце теперь является ссылкой, открывающейся в новом окне.  

Чёрт с ним, может вот так сделаем –  
<http://klimaleksus.narod.ru/Files/4/ytalert1V3.txt>  
–?

Русифицировал интерфейс.  
Ну и сделал отлов картиночки именно такой, какой нужно: вначале идёт запрос на картинку высокого качества, которая точно есть (как и название).  
Далее, если он пришёл – то название выставляется сразу, а ссылка на картинку – запоминается.  

При следующем обычном запросе, если вернулось название – то оно заменит имеющееся, но единожды (кстати, название видео у меня по таймеру вообще не обновляется. А надо?)  
Если пришла ссылка на картинку низкого качества – то вырисовывается она. Если же нет, то берётся сохранённая ссылка на большую если есть.

Когда таймер достигает «0» – на сервер посылается запрос на обновление данных, а таймер продолжает идти «в минус».  
Состояние запроса никак не отслеживается, то есть верный результат может либо придти, либо нет.

А значит, если ответа нет – через некоторое время нужно повторить посылку запроса (но да, потом могут придти сразу два).  
Например, если wait = 15, то запрос будет посылаться при таймере, равном 0, -15, -30, -45…  
(меньше 2 поставить нельзя, потому что от 0 до -1 происходит посылка, и где-то от -1 до -2 – приём, поэтому иначе повторный будет послан слишком рано.)

Вернее, даже вот так вот:  
<http://klimaleksus.narod.ru/Files/4/ytalert1V3.txt>  
(пофиг, по той же ссылке, просто перекачайте скрипт заново)

Я просто подумал, что браузер может кешировать запросы…  
Теперь всё скачивается через POST (ха, Ютюб не банит за это, как Гугль!), и к запросам добавляется случайное число, чтобы URL был формально каждый раз новый.

Там вроде есть кол-во просмотров, но оно было какое-то не очень адекватное, кажется.

Хотя, вроде работает:  
<http://klimaleksus.narod.ru/Files/4/ytalert1V4.txt>  
– а при наведении выдаётся и содержимое шорт-поля.

<http://klimaleksus.narod.ru/Files/4/ytalert1V5.txt>  
– теперь принимает список ссылок/идентификаторов, разделённых пробелом (вгружаются через секунду по-очереди, но добавляются одновременно).  
Такой список из текущей таблицы – выводится перед ней (ну чтобы можно было скопировать эту строку, и потом целиком и вставить)

---

_Оу, тут можно ещё кусочек про пад добавить, насчёт переполнения стека – косвенный пример:_

---

А вот что у меня было с Апачем.  
Забавно, но я делал такой же редактор в реальном времени, как пад – но графический, там можно было одновременно рисовать.  
Клиент посылал серверу JSON с перемещением курсора, а сервер сохранял его и пересылал всем остальным по их запросу.

Я хотел устроить хотя бы проверку валидности данных, чтобы клиенты не могли заспамить сервер мусором (он ведь вслепую ретранслирует всё другим клиентам), но без полного парсинга JSON для экономии ресурсов.

Я взял регулярное выражение типа такого:

`$r='/^\{"k":0\.[0-9]++,"u":[0-9]++,"l":\[(\{"t":[0-9]++,"r":[0-9]++,"c":[0-9]++,"b":"[0-9]++,[0-9]++,[0-9]++","k":0\.[0-9]++,"a":\[(\{"x":[0-9]++,"y":[0-9]++,"t":[0-9]++\},)*+\{"x":[0-9]++,"y":[0-9]++,"t":[0-9]++\}\]\},)*+(\{"t":[0-9]++,"r":[0-9]++,"c":[0-9]++,"b":"[0-9]++,[0-9]++,[0-9]++","k":0.[0-9]++,"a":\[(\{"x":[0-9]++,"y":[0-9]++,"t":[0-9]++\},)*+\{"x":[0-9]++,"y":[0-9]++,"t":[0-9]++\}\]\})*+\]\}$/ux';`

И применял его к строкам типа такой:

$s='{"k":0.03629016666673124,"u":0,"l":[{"t":581,"r":16,"c":1,"b":"264,0,0","k":0.03629016666673124,"a":[{"x":32800,"y":10700,"t":5},{"x":33149,"y":11198,"t":5},{"x":33497,"y":11696,"t":5},{"x":33846,"y":12194,"t":21},{"x":34195,"y":12692,"t":21},{"x":34532,"y":13198,"t":38},{"x":34955,"y":13635,"t":55},{"x":35378,"y":14071,"t":55},{"x":35906,"y":14373,"t":71},{"x":36434,"y":14675,"t":71},{"x":36961,"y":14977,"t":71},{"x":37489,"y":15279,"t":71},{"x":37978,"y":15641,"t":84},{"x":38467,"y":16002,"t":84}]},{"t":917,"r":16,"c":1,"b":"264,0,0","k":0.03629016666673124,"a":[{"x":43200,"y":17700,"t":4},{"x":43572,"y":17219,"t":35},{"x":43944,"y":16738,"t":35},{"x":44315,"y":16257,"t":35},{"x":44687,"y":15776,"t":35},{"x":45155,"y":15387,"t":50}]},{"t":230,"r":16,"c":1,"b":"264,0,0","k":0.03629016666673124,"a":[{"x":60900,"y":16800,"t":4}]},{"t":462,"r":16,"c":1,"b":"264,0,0","k":0.03629016666673124,"a":[{"x":53200,"y":11700,"t":5},{"x":52835,"y":11214,"t":5},{"x":52470,"y":10727,"t":5},{"x":52031,"y":10307,"t":21},{"x":51591,"y":9887,"t":21}]},{"t":680,"r":16,"c":1,"b":"264,0,0","k":0.03629016666673124,"a":[{"x":47400,"y":7700,"t":5},{"x":46792,"y":7700,"t":5},{"x":46184,"y":7700,"t":34}]},{"t":913,"r":16,"c":1,"b":"264,0,0","k":0.03629016666673124,"a":[{"x":37200,"y":21100,"t":5},{"x":37200,"y":21708,"t":5},{"x":37435,"y":22269,"t":35},{"x":37670,"y":22829,"t":35}]},{"t":117,"r":16,"c":1,"b":"264,0,0","k":0.03629016666673124,"a":[{"x":58900,"y":27900,"t":1},{"x":59506,"y":27947,"t":17},{"x":60112,"y":27993,"t":17},{"x":60720,"y":27996,"t":28},{"x":61328,"y":27998,"t":28}]},{"t":311,"r":16,"c":1,"b":"264,0,0","k":0.03629016666673124,"a":[{"x":62600,"y":28000,"t":7},{"x":62872,"y":28544,"t":19},{"x":63144,"y":29088,"t":19}]},{"t":518,"r":16,"c":1,"b":"264,0,0","k":0.03629016666673124,"a":[{"x":46500,"y":40600,"t":0},{"x":45892,"y":40600,"t":17},{"x":45284,"y":40600,"t":17},{"x":44676,"y":40600,"t":27},{"x":44068,"y":40600,"t":27},{"x":43460,"y":40600,"t":27}]},{"t":713,"r":16,"c":1,"b":"264,0,0","k":0.03629016666673124,"a":[{"x":40800,"y":36900,"t":4}]},{"t":929,"r":16,"c":1,"b":"264,0,0","k":0.03629016666673124,"a":[{"x":56900,"y":33000,"t":6},{"x":57508,"y":33000,"t":23},{"x":58116,"y":33000,"t":23}]},{"t":112,"r":16,"c":1,"b":"264,0,0","k":0.03629016666673124,"a":[{"x":68100,"y":37100,"t":4},{"x":68698,"y":37212,"t":14},{"x":69295,"y":37324,"t":14}]},{"t":296,"r":16,"c":1,"b":"264,0,0","k":0.03629016666673124,"a":[{"x":84600,"y":33400,"t":5}]}]}';

Но когда клиент водил мышью с особой ревностью, и строка становилась в сотни раз больше – сервер вылетал, перезапускался и соединение разрывалось без получения чего либо (в том числе, адекватной ошибки).

На сайтах пишут, что такие проблемы с preg_match($r,$s) только под Виндой. Потому Апач там по умолчанию скомпилирован с коротким стеком.  
А ещё рекомендовали перекомпилировать его, поменяв часть рекурсивного кода на линейный…  
(но тогда мне было вообще не до таких разборок, и мы просто забили на валидацию)

---

_(э, ладно, возьму-ка отсутствующий кусок текста про mysql из предыдущего поста – тот, что в архиве – и плейн-текстом фигану сюда. Ну там, для возможности поиска, тудым-сюдым…)_


---

Поскольку, исправлять баги и плясать с бубном, пока я всё это настраивал, мне приходилось постоянно и многократно – нужно, чтобы пользующиеся моей сборкой чётко понимали, как она работает внутри. Хоть я и свернул всё к простым кликам по .bat файлам, но обязательно что-то пойдёт не так.

Итак, в архиве – куча батников, и папка «MySQLServer5.5» – её переименовывать не надо. В ней есть файл «my.ini» – это основная конфигурация сервера.  
Нужно выгрузить это в папку, находящуюся (желательно) в корне жёсткого диска, например чтобы существовал путь:  
D:\TDTPAD_MySQL\MySQLServer5.5\my.ini

Теперь этот путь надо прописать в самой конфигурации дважды, и в моём файле «path.bat»:  
Там нужен путь типа «@set dir=D:\TDTPAD_MySQL\MySQLServer5.5»  
А файле конфигурации «my.ini» – два пути, один к этой папке, а второй – к её «DB» подпапке. Причём слеши там требуются прямые. То есть  
basedir="D:/TDTPAD_MySQL/MySQLServer5.5/"  
datadir="D:/TDTPAD_MySQL/MySQLServer5.5/DB/"

Все эти пути правильно прописывать ОЧЕНЬ важно. У меня было, что путь «С:\MySQL2\…» был неверен только потому, что там русская «С».  
Дальше:

Скрипт «MySQL_totalreset.bat» – очищает всё состояние базы данных до заводского, но не трогает конфигурационный файл. При запуске требует подтверждения – нужно ввести английскую букву «y» и нажать Enter.  
Будет сгенерирован новый локальный root пароль, который запишется в файл «pass.bat» и станет автоматически использоваться в дальнейшем.  
Откроется окно запущенного сервера с логом работы, если всё в порядке, его нужно закрыть.

Скрипт «MySQL_start.bat» – запускает сервер базы данных. По идее, он работает в фоне и не имеет консольного окна. Больше одного раза сервер запускать нельзя, будут глюки в виде пустых консольных окон или невыполняющихся команд и заблокированных файлов. Если такое случилось – убивайте сервер скриптом «MySQL_kill.bat»

Скрипт «MySQL_stop.bat» – останавливает работающий сервер. Может не сработать, если что-то с root-паролем случилось.

Скрипт «MySQL_kill.bat» – убивает все процессы, имя которых равно «tdtpad_mysqld.exe», это на случай, если предыдущая команда не заставила его остановиться.

Скрипт «MySQL_SHELL.bat» – открывает клиентское окно команд терминала MySQL (это туда надо вводить все те команды, которые можно нагуглить для решения той или иной проблемы), вообще говоря, через него можно сделать что угодно. Но самые главные функции вынесены в отдельные скрипты, а этот потребуется лишь для ручного вмешательства.

Скрипт «MySQL_STATUS.bat» – выводит на экран всю информацию о работе сервера – все процессы с его именем (должен быть один!), его общий статус, текущее состояние репликации и номер бинлога мастера. У меня всё сконфигирировано так, чтобы и мастер и реплика настраивались одинаково, надо просто знать, на что обращать внимание. Если статус вообще не печатается на экран – с сервером что-то не то.

Скрипт «MySQL_debug_log.bat» – запускает сервер (убедитесь, что больше ни одна провисшая копия не активна) в консольном режиме, с выводом лога на экран – сразу покажет примерную причину, почему вдруг сервер не запускается при штатной попытке.

– Ну со всем этим понятно как работать. Сначала «MySQL_totalreset.bat», потом «MySQL_start.bat» и сразу «MySQL_STATUS.bat». Если всё верно – то можно «MySQL_SHELL.bat» попробовать (если есть что писать туда), закрытие или перезапуск – «MySQL_stop.bat» и «MySQL_start.bat» снова. Если пустые окна остаются – то «MySQL_kill.bat», а если всё равно новая копия не поднимается – то «MySQL_debug_log.bat» и вчитываться.

Теперь ближе к паду. Кусочек конфигурации «settings.json» для etherpad-lite:

Так, во-первых, там вверху где «"ip": "127.0.0.1", "port" : 9001,» – айпи, кажется, надо писать «0.0.0.0» – тогда пад будет доступен на машине, независимо от её настоящего адреса (127.0.0.1 ли, 192.168.0.1, или любой внешний). Главное чтобы при подключении порт был тот, который указан тут.  
Во-вторых, все строки, связанные с «"dbType" : "dirty"» надо закомментировать или удалить.

В-третьих, раскомментировать секцию, связанную с mysql (настройки в ней объединены с dirty для упрощения выбора). У меня там есть нужный кусочек, вот такой:

"ip": "0.0.0.0",  
"port" : 9001,  

"dbType" : "mysql",  
//"dbType" : "dirty",  

"dbSettings" : {  
"user" : "etherpad",  
"host" : "localhost",  
"port" : "3311",  
"password": "my-awesome-etherpad-password",  
"database": "ep",  
"charset" : "utf8mb4",  
"filename" : "var/dirty.db"  
},

– здесь, «user» – имя пользователя для базы данных, которому разрешён нужный доступ, это слово «etherpad» (тогда полное его имя – это 'etherpad'@' localhost' );  
«port» – на каком порту будет ждать локальная база данных. В MySQL этот порт меняется дважды в конфигурационном файле, там написано «port=3311». Желательно, чтобы на всех используемых хостах этот порт был одинаковым (проблем при согласовании меньше будет).  
«database» – имя базы данных, куда пад будет всё сохранять. Это строка «ep», далее пойдут несколько работающих с ней скриптов.  
«password» – пароль для доступа к базе данных серверу пада. Эту строку можно изменить. Я вот думал, как бы сделать рандомную генерацию, но на самом деле этот пароль и никому не нужен, он же локальный и используется автоматически. Можно написать что угодно, просто скопировать в нужные места – и забыть о нём, ведь всё равно кроме как с «localhost» (это в MySQL настроено) никто к базе не присоединится.

Теперь нужно создать базу данных для пада. После запуска сервера, выполнить скрипт «install_db.bat» – это создаст базу данных «ep», и даст к ней доступ по заданному паролю. Чтобы поменять пароль, отредактируйте сам этот скрипт в Блокноте (менять в «identified by 'my-awesome-etherpad-password';»). Также, там разрешается репликация с этого сервера на любой адрес. Пароль репликации – в «identified by 'my-awesome-replication-password';», если его менять – то менять у всех; к тому же, этот пароль внешнего доступа ни на что, кроме самой репликации, и не даёт.

Наконец, пад можно запустить! В его настройках есть закомментированный кусок «//"dbType" : "dirty",», если поменять его с mysql, то пад переключиться на свою внутреннюю базу данных. Это можно использовать для открытия временного пада на своём хосте, пока MySQL настроен на репликацию главного – а временный пад использовать как средство связи, или писать там адреса альтернативных серверов (раз уж нормальной общей конфы нет).

Для экспорта базы данных, нужно выполнить скрипт «EP_export.bat». Он создаст файл типа «DUMP_$BINLOG.000001$810$.sql.7z», и это – всё содержимое всех падов Пада.  
Дамп хорошо сжат, и в его названии через «$» отделены параметры мастера, необходимые для старта репликации с него. Слово «DUMP» можно переименовать, но не используйте там специальных символов: только английские буквы, цифры и «_» да «-».  
Фишка! Чтобы расшарить его (да и не только), переместите файл в папку пада по адресу «\node_modules\ep_etherpad-lite\static\» – тогда он будет доступен из корня сайта (типа http://127.0.0.1:9001/DUMP_$BINLOG.000001$810$.sql.7z )

Для импорта – перетащить нужный «…$…$…$.sql.7z» файл на «EP_import.bat». Это _заменит_ текущее содержимое базы данных «ep» пада на то, что в файле. А вот после полного сброса сервера баз данных, то есть после «MySQL_totalreset.bat» – этой самой базы «ep» ещё не будет, и импорт не удастся: поэтому потребуется сначала запустить «install_db.bat».

Импортирование перехватывает параметры бинарных логов мастера для репликации, и сохраняет их в файл «blog.bat».  
Кстати! Везде пишут, что для экспорта с репликацией, мастер непременно нужно останавливать, иначе мы не получим значение лога после непосредственного экспорта, ведь в базе к этому времени уже может что-то поменяться. Но мой скрипт делает экспорт как можно быстрее, и сверяет параметры бинарных логов до и после. Если они совпали – значит всё отлично, никаких изменений в паде не было. А если нет – дамп, конечно, создаётся, но он будет непригоден для репликации.  
Скрипт позволяет зажать Пробел, чтобы продолжать пытаться заново создать правильные дампы до тех пор, пока не получится успеть между коммитами пада в базу. На крайняк можно просто попросить всех с полминуты ничего в пад не писать, либо всё же закрыть сервер пада, если совсем никак не экспортируется.

А вот как нужно настраивать репликацию.

На запасном хосте, нужно развернуть свою копию MySQL сервера, но в файле конфигурации «my.ini» требуется заранее обязательно изменить «server-id=11» на другое число. Пад можно не запускать, достаточно будет «install_db.bat» и импорта правильного дампа с мастера.

Теперь запускаем «replication_use.bat», и консоль спрашивает IP мастера. Его надо аккуратно ввести и нажать Enter. Будет выведен неинтерактивный статус. Окно можно закрыть, а вскоре – выполнить «MySQL_STATUS.bat», чтобы получить больше информации.

В этой большой таблице важнее всего пункты «Slave_IO_State:» – текущее состояние, должно быть что-то типа «Waiting for master to send event». Если там пусто, или какой-нить реконнект – плохо. «Seconds_Behind_Master:» – самое важно, если там «NULL» – репликация не работает. Должно быть число, обычно «0». А «Last_IO_Error:» – сообщение об ошибке, но я-ще не понял, как его очистить.  
Для перезапуска репликации – можно выполнить «replication_use.bat» и просто нажать Enter, чтобы взять старый IP.  
Если мастер работает на другом порту – откройте сам скрипт и поменяйте там «echo MASTER_PORT = 3311,»

Остановка репликации – «replication_stop.bat». Кстати, реплицирующий сервер (я надеюсь) блокирует себя для записи, поэтому запущенный к нему пад не должен заработать. Но всё равно, лучше не рисковать, и если на текущем хосте репликация – то в конфиге пада переключить на dirty.

Теперь весь процесс использования репликации:

Первое, назначаем главный хост у кого-нибудь, и запасные хосты.  
Каждый из них развёртывает MySQL и пад, проверяет, что всё работает. Запасные пады закрываются.

Второе, главный хост снимает дамп с базы (пусть, даже пока там ничего нет) и передаёт его остальным.  
Те импортируют дамп в базу, и запускают репликацию. Нужно быть уверенным, что она работает. (Для этого можно остановиться и запустить базу для пада, увидеть там новые изменения, всё сбросить и снова импортировать изначальный дамп – репликация всегда «догоняет» мастер от сохранённой точки то реального времени.)

Третье, запасные могут раскрыть пады, настроенные на dirtyDB, просто как альтернатива для связи.  
Но теперь вся работа проходит на основном хосте.

Четвёртое, мастер упал. Считаем, что связь с хостом потеряна полностью.  
Нужно решить, чья реплика теперь станет главной. Останавливаем её, и обязательно снимаем новый дамп со своего варианта базы, расшариваем его.  
Запускается пад, настроенный на mysql, и все переходят в него (правда, цвета и имена больше не будут соответствовать прошлым – это потому что хост другой, и cookie не пересекаются, браузеры войдут как в новый пад).

Пятое, все остальные запасные хосты скачивают дамп с этого, и перебрасывают репликацию на него.  
Если первый хост оживёт – он может подцепиться как ещё одна реплика.

Если по каким-то причинам, экспорт из базы стал неадекватно большим (хотя он ужимается) – можно просто запустить пад у себя, сделать оттуда экспорт в .etherpad, потом грохнуть базу нафиг, заново пересоздать, импортировать документ в пад, и снять дамп для репликации.

И напоследок:  
– чтобы сделать рут-пароль к mysql пустым, нужно удалить папки \data и \DB из \MySQLServer5.5\ (это уничтожит базу данных, если что) и вытащить их из файла \bin\restore – это обычный .7z архив. Теперь, удалить мой «pass.bat».

– чтобы использовать другой порт, меняйте в «my.ini» (мастер) и «replication_use.bat» (реплика).

– чтобы сменить пароль для базы пада, ищите в «install_db.bat» и «settings.json» самого пада. Пароль репликации меняется в «install_db.bat» (мастер) и «replication_use.bat» (реплика).

– ещё раз напомню, что путь к папе нудно менять вручную (то есть все файлы нельзя просто так взять и переместить куда-то), а именно в «my.ini» (два раза, с прямыми слешами) и в «path.bat».

– если будете разводить «локальные копии mysql», весящие на разных портах – во-первых, трижды перепроверяйте пути – не то будет так, что батник запускается из одной папки (путь path.bat), сервер на самом деле работает из другой (соединения проходят через порт, а где сам сервер при этом ж не важно), а используемые файлы самой базы – в третьей (my.ini может показывать куда угодно, например на файлы не своей копии mysql). А во-вторых, последний раз когда я проверял (у меня уже не было двух копмов под рукой) – у меня вообще репликация локально не заработала, до мастера не достучалась.

– имя процесса «mysqld.exe» (в \bin\) я намеренно изменил на «tdtpad_mysqld.exe», чтобы если что, не конфликтовать с потенциально имеющимися базами данных, запущенными на хосте. Поэтому, имя также должно быть прописано в «path.bat». Кстати, если на одной машине несколько копий сервера – команда «MySQL_kill.bat» убьёт все, а не только текущую.

Если кто желает сейчас проверить репликацию (пока я не забыл, как всё работает) – давайте. Я не претендую на то, что использовать её в продакшн. Точно сломается что-нибудь.

Если что, в моём архиве по факту уже выполнен «MySQL_totalreset.bat» и «install_db.bat». Файл «for settings.json» ни для чего не нужен, это просто кусок настроек для пада, а папка \tmp\ – туда я скинул все шаблоны для файла конфигурации, чтобы не мешали. Модуль «7za.exe» в \bin\ – добавлен мною, как и файл «restore», содержащий исходную версию внутренней базы самой MySQL. Прочие проги в \bin\, кажется, не нужны; но я не стал их трогать, чтобы не портить целостность самой сборки.

О, я подумал, что неплохо было бы оставить в файле «coment.txt» всё это моё сообщение, чтобы оно всегда находилось под рукой.

> – я почти закончил программу!  
> – ага, ага, закончил, конечно…  
> – и там код красиво оформлен!..  
> – ой, да ладно!!  
> – осталось справку коротенькую написать…  
> – коротенькую!? ВА-ХА-ХА

---

[Назад](./)
